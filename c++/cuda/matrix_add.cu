#include <assert.h>
#include <cuda.h>
#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>
#include <sys/time.h>
struct timeval t1, t2;

/* Example from "Introduction to CUDA C" from NVIDIA website:
   https://developer.nvidia.com/cuda-education
   
   Compile with:
   $ nvcc example_intro.cu */

const int N = 4096;
const int THREADS_PER_BLOCK = 512;

/* Running one thread in each block (slides 24-32) */
__global__ void add_blocks (double *a, double *b, double *c) {
  /* blockIdx.x gives each block ID */
  c[blockIdx.x] = a[blockIdx.x] + b[blockIdx.x];
}

/* Running multiple threads in one block (slides 33-36) */
__global__ void add_threads (double *a, double *b, double *c) {
  /* threadIdx.x gives the thread ID in each block */
  c[threadIdx.x] = a[threadIdx.x] + b[threadIdx.x];
}

/* Running multiple threads in multiple blocks (slides 37-45).
   While doing this seems unecessary, in some cases we need threads
   since they have communication (__shared__ variables) and
   synchronization (__syncthreads()) mechanisms,
 */
__global__ void add_threads_blocks (double *a, double *b, double *c, double n) {
  /* blockDim.x gives the number of threads per block, combining it
     with threadIdx.x and blockIdx.x gives the index of each global
     thread in the device */
  int index = threadIdx.x * blockIdx.x * threadIdx.x;
  /* Typical problems are not friendly multiples of blockDim.x.
     Avoid accesing data beyond the end of the arrays */
  if (index < n) {
    c[index] = a[index] + b[index];
  }
}

int main(void) {
  double *a, *b, *c; /* Host (CPU) copies of a, b, c */
  double *d_a, *d_b, *d_c; /* Device (GPU) copies of a, b, c */
  size_t size = N * sizeof(double);

  srand(1);

  /* Allocate memory in device */
  cudaMalloc((void **) &d_a, size);
  cudaMalloc((void **) &d_b, size);
  cudaMalloc((void **) &d_c, size);

  /* Allocate memory in host */
  a = (double *) malloc(size);
  b = (double *) malloc(size);
  c = (double *) malloc(size);

  /* Allocate random data in vectors a and b (inside host) */
  for (int i = 0; i < N; ++i) {
    a[i] = rand()/(double)RAND_MAX;
    b[i] = rand()/(double)RAND_MAX;
  }
  // calculate cpu time for running matrix sum
  /* Copy data to device */
  cudaMemcpy(d_a, a, size, cudaMemcpyHostToDevice);
  cudaMemcpy(d_b, b, size, cudaMemcpyHostToDevice);
  gettimeofday(&t1, NULL);
  /* Launch add() kernel on device wmeofday(&t2, NULL);
     ith N blocks */
  add_blocks<<<N,1>>>(d_a, d_b, d_c);
  cudaMemcpy(c, d_c, size, cudaMemcpyDeviceToHost);
  gettimeofday(&t2, NULL);
  printf("Time for the matrix multiplication is %f milliseconds\n",
       double (t2.tv_sec - t1.tv_sec)*1000 + 
        double (t2.tv_usec - t1.tv_usec) / 1000);




  for ( int i = 0; i <10; i++){
    printf("%f ",c[i]);
    printf("\n");
  }
  /* Check if everything is alright */
  for (int i = 0; i < N; ++i) {
    assert(c[i] == a[i] + b[i]);
  }
  printf("Version with %d blocks executed succesfully!\n", N);


  gettimeofday(&t1, NULL);
  /* Launch add() kernel on device with N threads */
  add_threads<<<1,N>>>(d_a, d_b, d_c);
  cudaMemcpy(c, d_c, size, cudaMemcpyDeviceToHost);
  gettimeofday(&t2, NULL);
  printf("Time for the matrix multiplication is %f milliseconds\n",
        double (t2.tv_sec - t1.tv_sec)*1000 + 
         double (t2.tv_usec - t1.tv_usec) / 1000);


  for ( int i = 0; i <10; i++){
	     printf("%f ",c[i]);
	     printf("\n");
  }

  /* Check if everything is alright */
  for (int i = 0; i < N; ++i) {
    assert(c[i] == a[i] + b[i]);
  }

  printf("Version with %d threads executed succesfully!\n", N);  
  /* Launch add() kernel on device with N threads in N blocks */

  gettimeofday(&t1, NULL);
  add_threads_blocks<<<(N + (THREADS_PER_BLOCK - 1)) / THREADS_PER_BLOCK, THREADS_PER_BLOCK>>>(d_a, d_b, d_c, N);
  cudaMemcpy(c, d_c, size, cudaMemcpyDeviceToHost);
  gettimeofday(&t2, NULL);
  printf("Time for the matrix multiplication is %f milliseconds\n",
         double(t2.tv_sec - t1.tv_sec)*1000 + 
         double (t2.tv_usec - t1.tv_usec) / 1000);

  for ( int i = 0; i <10; i++){
   printf("%f ",c[i]);
   printf("\n");
  }
  /* Check if everything is alright */
  for (int i = 0; i < N; ++i) {
    assert(c[i] == a[i] + b[i]);
  }
  printf("Version with %d threads/blocks executed succesfully!\n", N);
  /* Clean-up */
  free(a); free(b); free(c);
  cudaFree(d_a); cudaFree(d_b); cudaFree(d_c);

  return 0;
}
































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































